name: Coverage & GitHub Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  coverage:
    name: Coverage (${{ matrix.os_label }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            os_label: linux
          - os: windows-latest
            os_label: windows
          - os: macos-latest
            os_label: macos

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: actions-rs/toolchain@b2417cde72dcf67f306c0ae8e0828a81bf0b189f
        with:
          toolchain: stable
          override: true

      - name: Install llvm-cov tooling
        shell: bash
        run: |
          set -euo pipefail
          rustup component add llvm-tools-preview
          cargo install cargo-llvm-cov --locked

      - name: Generate coverage (json + html)
        shell: bash
        run: |
          set -euo pipefail
          cargo llvm-cov --ignore-filename-regex "main.rs" --json > coverage.json
          cargo llvm-cov --ignore-filename-regex "main.rs" --html

      - name: Generate coverage badge (per OS)
        shell: bash
        run: |
          set -euo pipefail

          LINE=$(jq '.data[0].totals.lines.percent' coverage.json)
          FUNC=$(jq '.data[0].totals.functions.percent' coverage.json)
          REGION=$(jq '.data[0].totals.regions.percent' coverage.json)

          PERCENT=$(echo "($LINE + $FUNC + $REGION)/3" | bc -l | xargs printf "%.2f")
          PERCENT_INT=$(printf "%.0f" "$PERCENT")

          if [ "$PERCENT_INT" -ge 90 ]; then COLOR="brightgreen";
          elif [ "$PERCENT_INT" -ge 75 ]; then COLOR="yellowgreen";
          else COLOR="red";
          fi

          cat > coverage_badge.json <<EOF
          {
            "schemaVersion": 1,
            "label": "coverage (${{ matrix.os_label }})",
            "message": "${PERCENT}%",
            "color": "${COLOR}"
          }
          EOF


      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os_label }}
          path: |
            target/llvm-cov/html
            coverage.json
            coverage_badge.json
          if-no-files-found: error

  build_pages:
    name: Build Pages site
    needs: coverage
    runs-on: ubuntu-latest

    steps:
      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Assemble site (reports + badges)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p site/coverage

          for os in linux windows macos; do
            mkdir -p "site/coverage/${os}"
            cp -r "artifacts/coverage-${os}/html/"* "site/coverage/${os}/"
          done

          for os in linux windows macos; do
            cp "artifacts/coverage-${os}/coverage_badge.json" "site/coverage-${os}.json"
          done

          sum=0
          for os in linux windows macos; do
            LINE=$(jq '.data[0].totals.lines.percent' "artifacts/coverage-${os}/coverage.json")
            FUNC=$(jq '.data[0].totals.functions.percent' "artifacts/coverage-${os}/coverage.json")
            REGION=$(jq '.data[0].totals.regions.percent' "artifacts/coverage-${os}/coverage.json")
            P=$(echo "($LINE + $FUNC + $REGION)/3" | bc -l)
            sum=$(echo "$sum + $P" | bc -l)
          done

          GLOBAL=$(echo "$sum/3" | bc -l | xargs printf "%.2f")
          GLOBAL_INT=$(printf "%.0f" "$GLOBAL")

          if [ "$GLOBAL_INT" -ge 90 ]; then COLOR="brightgreen";
          elif [ "$GLOBAL_INT" -ge 75 ]; then COLOR="yellowgreen";
          else COLOR="red";
          fi

          cat > site/coverage.json <<EOF
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "${GLOBAL}%",
            "color": "${COLOR}"
          }
          EOF

          cat > site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <title>scloud-dns Coverage</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 760px; margin: 40px auto; padding: 20px; line-height: 1.6; }
              h1 { margin-bottom: 0; }
              ul { padding-left: 20px; }
              a { text-decoration: none; color: #0070f3; }
              a:hover { text-decoration: underline; }
              code { background: #f3f3f3; padding: 2px 6px; border-radius: 4px; }
              .muted { margin-top: 30px; font-size: 0.9em; color: #888; }
            </style>
          </head>
          <body>
            <h1>scloud-dns â€“ Coverage Reports</h1>
            <p>Coverage reports generated on Linux, Windows, and macOS.</p>

            <h2>Reports</h2>
            <ul>
              <li><a href="coverage/linux/">Linux report</a></li>
              <li><a href="coverage/windows/">Windows report</a></li>
              <li><a href="coverage/macos/">macOS report</a></li>
            </ul>

            <h2>Badges (JSON endpoints)</h2>
            <ul>
              <li><a href="coverage.json">Global (average)</a></li>
              <li><a href="coverage-linux.json">Linux</a></li>
              <li><a href="coverage-windows.json">Windows</a></li>
              <li><a href="coverage-macos.json">macOS</a></li>
            </ul>

            <p class="muted">
              Generated by GitHub Actions using <code>cargo-llvm-cov</code>.
            </p>
          </body>
          </html>
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b
        with:
          path: site/

  deploy:
    needs: build_pages
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e
